<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: main/communicate.js</title>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="../../../global/styles/reset.css" />
    <link type="text/css" rel="stylesheet" href="../../../global/styles/prettify-tomorrow.css" />
    <link type="text/css" rel="stylesheet" href="../../../amdquery/ui/css/widget-ui.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <script src="../../../global/js/prettify.js" type="text/javascript"></script>
    <script src="../../../global/js/lang-css.js"></script>
    <script src="scripts/amdquery.js" amdquery="debug:false;" amd="detectCR=1" module="transitionToAnimation:1" ui="initWidget:1;isTransform3d:0;autoFetchCss:0"> </script>
    <script src="scripts/main.js"> </script>
</head>

<body style="width: 100%; height: 100%;" onload="prettyPrint()">

<div id="main" style="width: 100%; height: 100%;" amdquery-widget="ui.scrollableview" ui-scrollableview="orientation:V;enableKeyboard:true;focus:true">

    <h1 id="page-title" name="page-title" class="page-title">Source: main/communicate.js</h1>

    


    
    <section>
        <a float="false" id="Back" class="Back">Back</a>
        <article>
            <pre class="prettyprint source">aQuery.define( "main/communicate", [ "base/Promise", "base/typed", "base/extend", "main/event", "main/parse" ], function( $, Promise, typed, utilExtend, event, parse, undefined ) {
  "use strict";
  /**
   * @global
   * @typedef {Object} AjaxOptions
   * @property AjaxOptions {Object}
   * @property [AjaxOptions.type="GET"] {String} - "GET" or "POST"
   * @property AjaxOptions.url {String}
   * @property [AjaxOptions.data=""] {String|Object&lt;String,String>|Array&lt;Object&lt;String,String>>} - See {@link module:main/communicate.getURLParam}
   * @property [AjaxOptions.async=true] {Boolean}
   * @property [AjaxOptions.complete] {Function}
   * @property [AjaxOptions.header] {Object&lt;String,String>}
   * @property [AjaxOptions.isRandom] {Boolean}
   * @property [AjaxOptions.timeout=7000] {Number}
   * @property [AjaxOptions.fail] {Function} - Fail handler.
   * @property [AjaxOptions.dataType="text"] {String} - "json"|"xml"|"text"|"html"
   * @property [AjaxOptions.contentType="application/x-www-form-urlencoded"] {String}
   * @property [AjaxOptions.context=null] {Object} - Complete context.
   */

  /**
   * @global
   * @typedef {Object} JSONPOptions
   * @property JSONPOptions.url {String}
   * @property [JSONPOptions.charset="GBK"] {String}
   * @property [JSONPOptions.complete] {Function}
   * @property [JSONPOptions.isDelete=true] {Boolean} - Does delete the script.
   * @property [JSONPOptions.context=null] {Object} - Complete context.
   * @property [JSONPOptions.isRandom=false] {Boolean}
   * @property [JSONPOptions.checkString=""] {String} - Then JSONP back string.
   * @property [JSONPOptions.timeout=7000] {Number}
   * @property [JSONPOptions.fail] {Function} - Error handler.
   * @property [JSONPOptions.JSONP] {String|Boolean} - True is aQuery. String is JSONP.
   */

  /**
   * Event reporting that an ajax start.
   * @event aQuery#"ajaxStart"
   * @param {AjaxOptions}
   */

  /**
   * Event reporting that an ajax stop.
   * @event aQuery#"ajaxStop"
   * @param {AjaxOptions}
   */

  /**
   * Event reporting that an JSONP start.
   * @event aQuery#"jsonpStart"
   * @param {JSONPOptions}
   */

  /**
   * Event reporting that an JSONP stop.
   * @event aQuery#"jsonpStop"
   * @param {JSONPOptions}
   */

  /**
   * Export network requests.
   * &lt;br /> JSONP or AJAX.
   * @exports main/communicate
   * @requires module:base/typed
   * @requires module:base/extend
   * @requires module:main/event
   * @requires module:main/parse
   */
  var communicate = {
    /**
     * @param options {AjaxOptions}
     * @returns {module:base/Promise}
     */
    ajax: function( options ) {
      var ajax, timeId, o, e, type, promise;
      if ( options ) {
        ajax = communicate.getXhrObject();

        if ( ajax ) {

          o = utilExtend.extend( {}, communicate.ajaxSetting, options );

          type = o.type.toUpperCase();

          if ( o.isRandom == true && type == "GET" ) {
            o.data.random = $.now();
          }

          e = utilExtend.extend( {}, o );

          o.data = communicate.getURLParam( o.data );

          o.url = o.url.replace( /\?$/, "" );

          switch ( type ) {
            case "GET":
              if ( o.data ) {
                o.url += "?" + o.data;
              }
              break;
            case "POST":
              break;
          }

          if ( o.username ) {
            ajax.open( type, o.url, o.async, o.username, o.password );
          } else {
            ajax.open( type, o.url, o.async );
          }

          try {
            for ( var item in o.header ) {
              ajax.setRequestHeader( item, o.header[ item ] );
            }
            ajax.setRequestHeader( "Accept", o.dataType && o.accepts[ o.dataType ] ? o.accepts[ o.dataType ] + ", */*" : o.accepts._default );

          } catch ( error ) {}
          if ( o.data || options ) {
            ajax.setRequestHeader( "Content-Type", o.contentType );
          }
          //ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
          //type == "post" && ajax.setRequestHeader("Content-type", "");

          promise = Promise( function( ajax ) {
            var response;
            clearTimeout( timeId );
            e.type = "ajaxStop";
            $.trigger( e.type, ajax, e );
            switch ( o.dataType ) {
              case "json":
                response = parse.JSON( ajax.responseText );
                break;
              case "xml":
                response = ajax.responseXML;
                if ( !response ) {
                  try {
                    response = parse.XML( ajax.responseText );
                  } catch ( error ) {}
                }
                break;
              default:
              case "text":
                response = ajax.responseText;
                break;
            }
            o.complete && o.complete.call( o.context || ajax, response );

            o = null;
            return response;
          }, function( ajax ) {
            clearTimeout( timeId );
            ajax && ajax.abort();
            e.type = "ajaxStart";
            $.trigger( e.type, ajax, e );
            o.fail.call( o.context || ajax, ajax );
            o = null;
            return Promise().reject( ajax );
          }, function( ajax ) {
            if ( ajax.readyState == 4 ) {
              if ( ( ajax.status >= 200 && ajax.status &lt; 300 ) || ajax.status == 304 ) {
                return Promise().resolve( ajax );
              } else {
                return Promise().reject( ajax );
              }
            }
          } );

          ajax.onreadystatechange = function() {
            promise.reprocess( ajax );
          };
          if ( o.timeout ) {
            timeId = setTimeout( function() {
              promise.reject( ajax );
            }, o.timeout );
          }
          e.type = "ajaxStart";
          $.trigger( e.type, ajax, e );
          ajax.send( type == "GET" ? "NULL" : ( o.data || "NULL" ) );
          promise.reprocess( {} )
        }
      }

      return promise;
    },
    /**
     * @param list {Array&lt;AjaxOptions>}
     * @returns {module:base/Promise}
     */
    ajaxs: function( list ) {
      var promises = [];

      $.each( list, function( item, index ) {
        promises.push( communicate.ajax( item ) );
      } );

      return Promise.group( promises );
    },

    ajaxSetting:
    /**
     * @name ajaxSetting
     * @memberOf module:main/communicate
     * @property {Object}   ajaxSetting                     - AJAX default setting.
     * @property {String}   ajaxSetting.url
     * @property {String}   ajaxSetting.dataType            - "text".
     * @property {String}   ajaxSetting.type                - "GET".
     * @property {String}   ajaxSetting.contentType         - "application/x-www-form-urlencoded".
     * @property {Object}   ajaxSetting.context             - Complete context.
     * @property {Number}   ajaxSetting.timeout             - 7000 millisecond.
     * @property {Function} ajaxSetting.fail                - Fail handler.
     * @property {null}     ajaxSetting.header
     * @property {Boolean}  ajaxSetting.isRandom            - False.
     * @property {Object}   ajaxSetting.accepts
     * @property {String}   ajaxSetting.accepts.xml         - "application/xml, text/xml".
     * @property {String}   ajaxSetting.accepts.html        - "text/html".
     * @property {String}   ajaxSetting.accepts.json        - "application/json, text/javascript".
     * @property {String}   ajaxSetting.accepts.text        - "text/plain".
     */
    {
      url: location.href,
      dataType: "text",
      type: "GET",
      contentType: "application/x-www-form-urlencoded; charset=UTF-8",
      context: null,
      async: true,
      timeout: 7000,
      fail: function() {
        $.logger( "ajax fail" );
      },
      header: null,
      isRandom: false,
      accepts: {
        xml: "application/xml, text/xml",
        html: "text/html",
        json: "application/json, text/javascript",
        text: "text/plain",
        _default: "*/*"
      }
    },
    /**
     * @param options {JSONPOptions}
     * @returns {module:base/Promise}
     */
    jsonp: function( options ) {
      var scripts = document.createElement( "script" ),
        head = document.getElementsByTagName( "HEAD" ).item( 0 ),
        o = utilExtend.extend( true, {}, communicate.jsonpSetting, options ),
        e = utilExtend.extend( e, o ),
        data = "",
        timeId, random = "",
        promise;

      if ( o.JSONP ) {
        random = ( "aQuery" + $.now() ) + parseInt( Math.random() * 10 );
        window[ random ] = function( json ) {
          promise.reprocess( json );
        };
        o.data[ o.JSONP ] = random
      }

      if ( o.isRandom == true ) {
        o.data.random = $.now();
      };

      data = communicate.getURLParam( o.data );

      o.url = o.url.replace( /\?$/, "" );

      o.url += data == "" ? data : "?" + data;

      function clear() {
        clearTimeout( timeId );
        if ( window[ random ] ) {
          delete window[ random ];
          random = null;
        }
        e.type = "jsonpStop";
        $.trigger( e.type, scripts, e );
        typed.isNode( scripts.nodeName, "script" ) && o.isDelete == true && head.removeChild( this );
        scripts.removeAttribute( "src" );
        head = scripts = scripts.onload = scripts.onreadystatechange = scripts.onerror = null;
      }

      promise = Promise( function( json ) {
        typed.isFunction( o.complete ) && o.complete.call( o.context || scripts, json );
        clear();
        return json;
      }, function() {
        typed.isFunction( o.fail ) && o.fail.call( o.context || scripts, o );
        clear();
        return Promise().reject( o );
      }, function( json ) {
        if ( json ) {
          Promise().resolve( json );
        }
      } );

      scripts.onerror = function() {
        promise.reject();
      };

      o.timeout && ( timeId = setTimeout( scripts.onerror, o.timeout ) );

      scripts.setAttribute( "src", o.url );
      o.charset && scripts.setAttribute( "charset", o.charset );
      scripts.setAttribute( "type", "text/javascript" );
      scripts.setAttribute( "language", "javascript" );
      e.type = "jsonpStart";
      $.trigger( e.type, scripts, e );
      head.insertBefore( scripts, head.firstChild );
      return promise.reprocess();
    },
    jsonpSetting:
    /**
     * @name ajaxSetting
     * @memberOf module:main/communicate
     * @property {Object}         jsonpSetting                    - JSONP default setting.
     * @property {String}         ajaxSetting.url                 - "".
     * @property {String}         ajaxSetting.charset             - "GBK".
     * @property {Boolean}        ajaxSetting.isDelete            - true.
     * @property {Boolean}        ajaxSetting.isRandom            - false.
     * @property {String}         ajaxSetting.JSONP               - "callback".
     * @property {Number}         ajaxSetting.timeout             - 7000 millisecond.
     * @property {Function}       ajaxSetting.fiail               - Error handler.
     * @property {Object}         ajaxSetting.data                - Query string.
     */
    {
      charset: "GBK",
      fail: function() {
        $.logger( "aQuery.jsonp", ( this.src || "(empty)" ) + " of javascript getting error" );
      },
      isDelete: true,
      isRandom: false,
      JSONP: "callback",
      timeout: 7000,
      url: "",
      data: {}
    },
    /**
     * @param list {Array&lt;JSONPOptions>}
     * @returns {module:base/Promise}
     */
    jsonps: function( list ) {
      var promises = [];

      $.each( list, function( item, index ) {
        promises.push( communicate.jsonp( item ) );
      } );

      return Promise.group( promises );
    },
    /**
     * @example
     * communicate.getURLParam( {
     *   id: "00001",
     *   name: "Jarry"
     * } );
     * communicate.getURLParam( [
     *   {
     *     name: "id",
     *     value: "000001"
     *   },
     *   {
     *     name: "name",
     *     value: "Jarry"
     *   }
     * ] );
     * // output: "id=00001&name=Jarry"
     * @param {String|Object&lt;String, String>|Array&lt;Object&lt;String,String>>}
     * @returns {String}
     */
    getURLParam: function( content ) {
      var list = [];
      if ( typed.isObject( content ) ) {
        $.each( content, function( value, name ) {
          value = typed.isFunction( value ) ? value() : value;
          !typed.isNul( value ) && list.push( encodeURIComponent( name ) + "=" + encodeURIComponent( value ) );
        } );
        content = list.join( "&" );
      } else if ( typed.isArray( content ) ) {
        $.each( content, function( item ) {
          !typed.isNul( item.value ) && list.push( encodeURIComponent( item.name ) + "=" + encodeURIComponent( item.value ) );
        } );
        content = list.join( "&" );
      } else if ( !typed.isString( content ) ) {
        content = "";
      }
      return content;
    },
    /**
     * If return null means it does not support XMLHttpRequest.
     * @returns {?XMLHttpRequest}
     */
    getXhrObject: function() {
      var xhr = null;
      if ( window.ActiveXObject ) {
        $.each( [ "Microsoft.XMLHttp", "MSXML2.XMLHttp", "MSXML2.XMLHttp.6.0", "MSXML2.XMLHttp.5.0", "MSXML2.XMLHttp.4.0", "MSXML2.XMLHttp.3.0" ], function( value ) {
          try {
            xhr = new ActiveXObject( value );
            return xhr;
          } catch ( e ) {

          }
        }, this );
      } else {
        try {
          xhr = new XMLHttpRequest();
        } catch ( e ) {}
      }
      if ( !xhr ) {
        $.logger( "getXhrObject", "broswer no support AJAX" );
      }

      return xhr;
    }
  };

  return communicate;
} );</pre>
        </article>
        <script type="text/javascript">
          var Back = document.getElementById("Back");
          if (Back){
            Back.onclick = function(){
              if (window.history && window.history.length) {
                window.history.back();
              }
            }
          }
        </script>
    </section>





    <a float="false" href="#page-title" class="Top">Top</a>
</div>

<br clear="both">

</body>
</html>
